define(["jquery","core/templates","core/modal_factory","auth_mumie/mumie_server_config","core/ajax"],function(){function a(a){for(;a.firstChild;)a.removeChild(a.firstChild)}function b(){return""===document.getElementsByName("mumie_missing_config")[0].getAttribute("value")}var c=document.getElementById("id_add_server_button"),d=document.getElementsByName("mumie_missing_config")[0],e=function(){var b,c=document.getElementById("id_server");return{init:function(a){b=a,c.onchange=function(){f.updateOptions(),g.updateOptions(),i.updateOptions(),h.updateOptions()}},getSelectedServer:function(){var a=c.options[c.selectedIndex].text;for(var d in b){var e=b[d];if(e.name==a)return e}},setDropDownListeners:function(){},disable:function(){c.disabled=!0,a(c)}}}(),f=function(){function b(a){var b=document.createElement("option");b.setAttribute("value",a.name),b.text=a.name,d.append(b)}function c(){j.value=f.getSelectedCourse().coursefile}var d=document.getElementById("id_mumie_course"),j=document.getElementsByName("mumie_coursefile")[0];return{init:function(a){d.onchange=function(){c(),g.updateOptions(),i.updateOptions(),h.updateOptions()},f.updateOptions(!!a&&j.value)},getSelectedCourse:function(){var a=d.options[d.selectedIndex].text,b=e.getSelectedServer().courses;for(var c in b){var f=b[c];if(f.name==a)return f}},setDropDownListeners:function(){},disable:function(){d.disabled=!0,a(d)},updateOptions:function(f){a(d),d.selectedIndex=0;var g=e.getSelectedServer().courses;for(var h in g){var i=g[h];b(i),i.coursefile==f&&(d.selectedIndex=d.childElementCount-1)}c()}}}(),g=function(){function b(a){var b=document.createElement("option");b.setAttribute("value",a),b.text=a,c.append(b)}var c=document.getElementById("id_language");return{init:function(){c.onchange=function(){h.updateOptions()},g.updateOptions()},getSelectedLanguage:function(){return c.options[c.selectedIndex].text},disable:function(){c.disabled=!0,a(c)},updateOptions:function(){var d=g.getSelectedLanguage();a(c),c.selectedIndex=0;var e=f.getSelectedCourse().languages;for(var h in e){var i=e[h];b(i),i==d&&(c.selectedIndex=c.childElementCount-1)}}}}(),h=function(){function b(){k.value=c(h.getSelectedTask())}function c(a){if(!a)return null;for(var b in a.headline){var c=a.headline[b];if(c.language==g.getSelectedLanguage())return c.name}return null}function d(a){return a.link+"?lang="+g.getSelectedLanguage()}function e(a){if(null!==c(a)){var b=document.createElement("option");b.setAttribute("value",d(a)),b.text=c(a),j.append(b)}}var j=document.getElementById("id_taskurl"),k=document.getElementById("id_name");return{init:function(a){b(),j.onchange=function(){b()},h.updateOptions(a?j.options[j.selectedIndex].getAttribute("value"):void 0)},getSelectedTask:function(){var a=void 0==j.options[j.selectedIndex]?void 0:j.options[j.selectedIndex].getAttribute("value"),b=f.getSelectedCourse().tasks;for(var c in b){var e=b[c];if(a==d(e))return e}},disable:function(){j.disabled=!0,a(j)},updateOptions:function(c){a(j),j.selectedIndex=0;var g=i.filterTasks(f.getSelectedCourse().tasks);for(var h in g){var k=g[h];e(k),c===d(k)&&(j.selectedIndex=j.childElementCount-1)}b()}}}(),i=function(){function b(a){var b=document.createElement("div");b.classList.add("row","fitem","form-group","mumie-filter");var d=c(a),f=document.createElement("label");f.innerHTML='<i class="fa fa-caret-down mumie-icon"></i>'+a.name,f.classList.add("col-md-3","mumie-collapsable"),f.onclick=function(){e(d)},b.appendChild(f),b.appendChild(d),l.appendChild(b)}function c(a){var b=document.createElement("div");b.classList.add("col-md-9","felement","mumie_selection_box");for(var c in a.values){n[a.name]=[];var e=document.createElement("div");e.classList.add("mumie_input_wrapper");var f=a.values[c],g=document.createElement("input");g.type="checkbox",g.value=f,d(a,g);var h=document.createElement("label");h.innerText=f,h.style="padding-left: 5px",e.appendChild(g),e.appendChild(h),b.appendChild(e)}return b}function d(a,b){b.onclick=function(){if(b.checked)n[a.name].push(b.value);else{var c=[];for(var d in n[a.name]){var e=n[a.name][d];e!=b.value&&c.push(e)}n[a.name]=c}h.updateOptions()}}function e(a){a.toggleAttribute("hidden")}function g(a,b){var c=[];for(var d in a){var e=a[d];i(e,b)&&c.push(e)}return c}function i(a,b){var c=[];for(e in a.tags){var d=a.tags[e];c[d.name]=d.values}for(var e in Object.keys(b)){var f=Object.keys(b)[e];if(0!=b[f].length){if(!c[f])return!1;if(!j(b[f],c[f]))return!1}}return!0}function j(a,b){if(!Array.isArray(a)||!Array.isArray(b))return!1;for(var c=0;c<a.length;c++)if(b.includes(a[c]))return!0;return!1}var k=document.getElementById("mumie_filter_section"),l=document.getElementById("mumie_filter_wrapper"),m=document.getElementById("mumie_filter_header"),n=[];return{init:function(){this.updateOptions(),m.onclick=function(){e(l)}},updateOptions:function(){var c=f.getSelectedCourse().tags;n=[],c.length>0?k.hidden=!1:k.hidden=!0,a(l);for(var d in c){var e=c[d];b(e)}},filterTasks:function(a){return g(a,n)}}}();return{init:function(a){var j=document.getElementById("id_name").getAttribute("value");j&&!b()?(require(["core/str","core/notification"],function(a,b){a.get_strings([{key:"mumie_form_missing_server",component:"mod_mumie"}]).done(function(a){b.addNotification({message:a[0]+"<b>"+d.getAttribute("value")+"</b>",type:"problem"})}).fail(b.exception)}),e.disable(),f.disable(),g.disable(),h.disable()):require(["core/ajax"],function(b){b.call([{methodname:"auth_mumie_get_server_structure",args:{contextid:a},done:function(a){e.init(JSON.parse(a)),f.init(j),h.init(j),g.init(),i.init()},fail:function(a){alert(JSON.stringify(a))}}])}),c&&require(["auth_mumie/mumie_server_config"],function(b){b.init(c,a)})}}});