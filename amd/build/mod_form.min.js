define(["jquery","core/templates","core/modal_factory","auth_mumie/mumie_server_config","core/ajax"],function(){function a(a){for(;a.firstChild;)a.removeChild(a.firstChild)}function b(){return""===document.getElementsByName("mumie_missing_config")[0].getAttribute("value")}var c=document.getElementById("id_add_server_button"),d=document.getElementsByName("mumie_missing_config")[0],e=function(){var b,c=document.getElementById("id_server");return{init:function(a){b=a,c.onchange=function(){f.updateOptions(),g.updateOptions(),i.updateOptions(),h.updateOptions()}},getSelectedServer:function(){var a=c.options[c.selectedIndex].text;for(var d in b){var e=b[d];if(e.name==a)return e}return null},disable:function(){c.disabled=!0,a(c)},getAllServers:function(){return b}}}(),f=function(){function b(a){var b,c=document.createElement("option"),e=g.getSelectedLanguage();if(a.languages.includes(e))for(var f in a.name)a.name[f].language==e&&(b=a.name[f]);else b=a.name[0];c.setAttribute("value",b.value),c.text=b.value,d.append(c)}function c(){j.value=f.getSelectedCourse().coursefile}var d=document.getElementById("id_mumie_course"),j=document.getElementsByName("mumie_coursefile")[0];return{init:function(a){d.onchange=function(){c(),g.updateOptions(),i.updateOptions(),h.updateOptions()},f.updateOptions(!!a&&j.value)},getSelectedCourse:function(){var a=d.options[d.selectedIndex].text,b=e.getSelectedServer().courses;for(var c in b){var f=b[c];for(var g in f.name)if(f.name[g].value==a)return f}return null},disable:function(){d.disabled=!0,a(d)},updateOptions:function(f){a(d),d.selectedIndex=0;var g=e.getSelectedServer().courses;for(var h in g){var i=g[h];b(i),i.coursefile==f&&(d.selectedIndex=d.childElementCount-1)}c()}}}(),g=function(){function b(a){var b=document.createElement("option");b.setAttribute("value",a),b.text=a,c.append(b)}var c=document.getElementById("id_language");return{init:function(){c.onchange=function(){h.updateOptions(),f.updateOptions()},g.updateOptions()},getSelectedLanguage:function(){return c.options[c.selectedIndex].text},disable:function(){c.disabled=!0,a(c)},updateOptions:function(){var d=g.getSelectedLanguage();a(c),c.selectedIndex=0;var e=f.getSelectedCourse().languages;for(var h in e){var i=e[h];b(i),i==d&&(c.selectedIndex=c.childElementCount-1)}}}}(),h=function(){function b(){c()||(r.value=d(h.getSelectedTask()))}function c(){return 0!=r.value.length&&!k().includes(r.value)}function d(a){if(!a)return null;for(var b in a.headline){var c=a.headline[b];if(c.language==g.getSelectedLanguage())return c.name}return null}function j(){var a=[];for(var b in e.getAllServers()){var c=e.getAllServers()[b];for(var d in c.courses){var f=c.courses[d];for(var g in f.tasks){var h=f.tasks[g];a.push(h)}}}return a}function k(){var a=[],b=j();b.push(o(f.getSelectedCourse()));for(var c in b){var d=b[c];for(var e in d.headline)a.push(d.headline[e].name)}var g=f.getSelectedCourse();for(var h in g.name){var i=g.name[h];a.push(i.value)}return a}function l(a){return a.link+"?lang="+g.getSelectedLanguage()}function m(a){if(null!==d(a)){var b=document.createElement("option");b.setAttribute("value",l(a)),b.text=d(a),q.append(b)}}function n(a){var b=o(a),c=document.createElement("option");c.setAttribute("value",l(b)),c.text=d(b),q.append(c)}function o(a){var b=[];for(var c in a.name){var d=a.name[c];b.push({name:d.value,language:d.language})}return{link:a.link,headline:b}}function p(){return s.checked}var q=document.getElementById("id_taskurl"),r=document.getElementById("id_name"),s=document.getElementById("id_mumie_complete_course");return{init:function(a){b(),q.onchange=function(){b()},s.onchange=function(){h.updateOptions(),i.updateOptions()},h.updateOptions(a?q.options[q.selectedIndex].getAttribute("value"):void 0)},getSelectedTask:function(){var a=void 0==q.options[q.selectedIndex]?void 0:q.options[q.selectedIndex].getAttribute("value"),b=f.getSelectedCourse(),c=b.tasks.slice();c.push(o(b));for(var d in c){var e=c[d];if(a==l(e))return e}return null},disable:function(){q.disabled=!0,a(q)},updateOptions:function(c){if(a(q),q.selectedIndex=0,p())n(f.getSelectedCourse());else{var d=i.filterTasks(f.getSelectedCourse().tasks);for(var e in d){var g=d[e];m(g),c===l(g)&&(q.selectedIndex=q.childElementCount-1)}}b()},useCompleteCourse:function(){return p()}}}(),i=function(){function b(a){var b=document.createElement("div");b.classList.add("row","fitem","form-group","mumie-filter");var d=c(a),f=document.createElement("label");f.innerHTML='<i class="fa fa-caret-down mumie-icon"></i>'+a.name,f.classList.add("col-md-3","mumie-collapsable"),f.onclick=function(){e(d)},b.appendChild(f),b.appendChild(d),l.appendChild(b)}function c(a){var b=document.createElement("div");b.classList.add("col-md-9","felement","mumie_selection_box");for(var c in a.values){n[a.name]=[];var e=document.createElement("div");e.classList.add("mumie_input_wrapper");var f=a.values[c],g=document.createElement("input");g.type="checkbox",g.value=f,d(a,g);var h=document.createElement("label");h.innerText=f,h.style="padding-left: 5px",e.appendChild(g),e.appendChild(h),b.insertBefore(e,b.firstChild)}return b}function d(a,b){b.onclick=function(){if(b.checked)n[a.name].push(b.value);else{var c=[];for(var d in n[a.name]){var e=n[a.name][d];e!=b.value&&c.push(e)}n[a.name]=c}h.updateOptions()}}function e(a){a.toggleAttribute("hidden")}function g(a,b){var c=[];for(var d in a){var e=a[d];i(e,b)&&c.push(e)}return c}function i(a,b){var c=[];for(var d in a.tags){var e=a.tags[d];c[e.name]=e.values}for(var f in Object.keys(b)){var g=Object.keys(b)[f];if(0!=b[g].length){if(!c[g])return!1;if(!j(b[g],c[g]))return!1}}return!0}function j(a,b){if(!Array.isArray(a)||!Array.isArray(b))return!1;for(var c=0;c<a.length;c++)if(b.includes(a[c]))return!0;return!1}var k=document.getElementById("mumie_filter_section"),l=document.getElementById("mumie_filter_wrapper"),m=document.getElementById("mumie_filter_header"),n=[];return{init:function(){this.updateOptions(),m.onclick=function(){e(l)}},updateOptions:function(){h.useCompleteCourse()?k.style="display: none":k.style="display: flex";var c=f.getSelectedCourse().tags;n=[],c.length>0?k.hidden=!1:k.hidden=!0,a(l);for(var d in c){var e=c[d];b(e)}},filterTasks:function(a){return g(a,n)}}}();return{init:function(a){var j=document.getElementById("id_name").getAttribute("value");j&&!b()?(require(["core/str","core/notification"],function(a,b){a.get_strings([{key:"mumie_form_missing_server",component:"mod_mumie"}]).done(function(a){b.addNotification({message:a[0]+"<b>"+d.getAttribute("value")+"</b>",type:"problem"})}).fail(b.exception)}),e.disable(),f.disable(),g.disable(),h.disable()):(e.init(JSON.parse(document.getElementsByName("mumie_server_structure")[0].value)),f.init(j),h.init(j),g.init(),i.init()),c&&require(["auth_mumie/mumie_server_config"],function(b){b.init(c,a)})}}});